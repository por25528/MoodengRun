<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Game</title>
</head>
<body>
    <script type="module">
        import kaboom from "https://unpkg.com/kaboom@3000.0.1/dist/kaboom.mjs";

        const FLOOR_HEIGHT = 300;
        const JUMP_FORCE = 1600;
        const SPEED = 900;
        const MAX_HEALTH = 5;
        const INITIAL_SPAWN_DELAY = 3;
        const MIN_SPAWN_DELAY = 0.7;
        const INITIAL_HEALING_DELAY = 3;
        const MIN_HEALING_DELAY = 1;

        kaboom({
            width: window.innerWidth, 
            height: window.innerHeight, 
            scale: 1, 
        });

        let isDropping = false;
        let obstacles = [];
        let enemies = [];

        const responsiveScale = Math.min(width() / 1920, height() / 1080); 

        loadSprite("heart", "sprites/heart.png");
        loadSprite("water", "sprites/Water.png");
        loadSprite("background", "sprites/Wallpaper.png");
        loadSprite("moodeng", "sprites/MooDeng.png");
        loadSprite("human1", "sprites/Human1.png");
        loadSprite("human2", "sprites/Human2.png");
        loadSprite("humanfloat", "sprites/Humanfloat1.png");
        loadSprite("spike", "sprites/spike.png");

        loadSound("jump", "sounds/jump.mp3");
        loadSound("lose", "sounds/lose.mp3");
        loadSound("heal", "sounds/heal.mp3");
        loadSound("damage", "sounds/damage.mp3");

        scene("game", () => {
            setGravity(2400 * responsiveScale);

            
            add([
                sprite("background", { width: width(), height: height() }),  
                pos(0, 0),
            ]);

            const player = add([
                sprite("moodeng"),
                pos(40 * responsiveScale, 40 * responsiveScale),
                area(),
                body(),
                scale(0.5 * responsiveScale), 
            ]);

            let health = MAX_HEALTH;
            let canJump = true;

            function updateHealthDisplay() {
                    for (let h of healthLabel) {
                        destroy(h);
                    }
                    healthLabel = [];

                    const heartGap = 45 * responsiveScale;

             
                    for (let i = 0; i < health; i++) {
                        healthLabel.push(
                            add([
                                sprite("heart"),
                                pos(50 * responsiveScale + i * (24 * responsiveScale + heartGap), 24 * responsiveScale),
                                scale(0.3 * responsiveScale),
                            ])
                        );
                    }
                }

            let healthLabel = [];
            updateHealthDisplay();

            add([
                rect(width(), FLOOR_HEIGHT * responsiveScale),
                outline(4 * responsiveScale),
                pos(0, height()),
                anchor("botleft"),
                area(),
                body({ isStatic: true }),
                color(0, 255, 0),
                outline(4 * responsiveScale, color(0, 100, 0)),
            ]);

            onClick(() => {
                if (player.isGrounded()) {
                    player.jump(JUMP_FORCE * responsiveScale);
                    play("jump");
                } else {
                    if (!isDropping) {
                        isDropping = true;
                        const originalGravity = getGravity();
                        setGravity(20000 * responsiveScale);
                        player.jump(-player.pos.y);
                        player.onGround(() => {
                            setGravity(originalGravity);
                            isDropping = false;
                        });
                    }
                }
            });

            player.onGround(() => {
                canJump = true;
            });

            let spawnDelay = INITIAL_SPAWN_DELAY;
            let healingDelay = INITIAL_HEALING_DELAY;

            function spawnObstacle() {
                const obstacleType = rand() < 0.5 ? "spike" : "human";
                if (obstacleType === "spike") {
                    let safeToSpawn = true;
                    for (let enemy of enemies) {
                        if (enemy.pos.x < width() && enemy.pos.x > width() - 200 * responsiveScale) {
                            safeToSpawn = false;
                            break;
                        }
                    }

                    if (safeToSpawn) {
                        obstacles.push(
                            add([
                                sprite("spike"),
                                pos(width(), height() - FLOOR_HEIGHT * responsiveScale - 50 * responsiveScale),
                                area(),
                                move(LEFT, SPEED * responsiveScale),
                                offscreen({ destroy: true }),
                                "spike",
                                scale(2 * responsiveScale),
                            ])
                        );
                    }
                }
                wait(spawnDelay, spawnObstacle);
            }

            function spawnRandomEnemy() {
                const enemyType = rand() < 0.5 ? "human" : "floating";
                if (enemyType === "human") {
                    const humanSprite = rand() < 0.5 ? "human1" : "human2";
                    const enemy = add([
                        sprite(humanSprite),
                        area(),
                        outline(4 * responsiveScale),
                        pos(width(), height() - FLOOR_HEIGHT * responsiveScale),
                        anchor("botleft"),
                        move(LEFT, SPEED * responsiveScale),
                        offscreen({ destroy: true }),
                        "human",
                        scale(2 * responsiveScale),
                    ]);
                    enemies.push(enemy);
                } else {
                    const floatingEnemy = add([
                        sprite("humanfloat"),
                        area(),
                        pos(width(), rand(40 * responsiveScale, 100 * responsiveScale)),
                        move(LEFT, SPEED * responsiveScale),
                        offscreen({ destroy: true }),
                        "floating",
                        scale(1.5 * responsiveScale),
                    ]);
                    enemies.push(floatingEnemy);
                }
                wait(spawnDelay, spawnRandomEnemy);
            }

            function spawnHealingItem() {
                if (rand() < 0.10) {
                    const healingItem = add([
                        sprite("water"),
                        pos(width(), rand(height() - FLOOR_HEIGHT * responsiveScale - 250 * responsiveScale, height() - FLOOR_HEIGHT * responsiveScale - 100 * responsiveScale)),
                        area(),
                        move(LEFT, SPEED * responsiveScale),
                        offscreen({ destroy: true }),
                        "healing",
                        scale(3 * responsiveScale),
                    ]);
                    wait(healingDelay, spawnHealingItem);
                } else {
                    wait(1, spawnHealingItem);
                }
            }

            spawnRandomEnemy();
            spawnObstacle();
            spawnHealingItem();

            player.onCollide("human", () => {
                play("damage");
                health--;
                updateHealthDisplay();
                if (health <= 0) {
                    play("lose");
                    go("lose", score);
                }
            });

            player.onCollide("floating", () => {
                play("damage");
                health--;
                updateHealthDisplay();
                if (health <= 0) {
                    play("lose");
                    go("lose", score);
                }
            });

            player.onCollide("healing", (healingItem) => {
                play("heal");
                health = Math.min(health + 1, MAX_HEALTH);
                updateHealthDisplay();
                destroy(healingItem);
            });

            player.onCollide("spike", () => {
                play("damage");
                health--;
                updateHealthDisplay();
                if (health <= 0) {
                    play("lose");
                    go("lose", score);
                }
            });

            let score = 0;

            const scoreLabel = add([
                text(score, { size: 48 * responsiveScale, font: "bold" }), 
                pos(width() - 150 * responsiveScale, 24 * responsiveScale), 
            ]);

            onUpdate(() => {
                score++;
                scoreLabel.text = score;

                if (spawnDelay > MIN_SPAWN_DELAY) {
                    spawnDelay -= 0.0005;
                }

                if (healingDelay > MIN_HEALING_DELAY) {
                    healingDelay -= 0.0005;
                }
            });
        });

        scene("lose", (score) => {
            add([
                sprite("background"),  
                pos(0, 0),
                scale(width() / 320 * responsiveScale, height() / 240 * responsiveScale), 
            ]);

            add([
                sprite("moodeng"),
                pos(width() / 2, height() / 2 - 64 * responsiveScale),
                scale(2 * responsiveScale), 
                anchor("center"),
            ]);

         
            add([
                text("Score: " + score),
                pos(width() / 2, height() / 2 + 64 * responsiveScale),
                scale(2 * responsiveScale),
                anchor("center"),
            ]);

            onKeyPress("space", () => go("game"));
            onClick(() => go("game"));
        });

        go("game");
    </script>
</body>
</html>
